<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anthropology History Flowchart</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        #flowchart-container {
            width: 100%;
            overflow: auto;
            border: 1px solid #ddd;
            background: white;
            transform-origin: 0 0;
            transform: scale(1);
            transition: transform 0.25s;
        }
        
        #zoom-controls {
            margin: 10px 0;
        }
        
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .popup-content {
            background: white;
            width: 70%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
            border-radius: 5px;
            position: relative;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
        }
        
        .node-data {
            display: none;
        }
        
        button {
            padding: 5px 10px;
            margin-right: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>History of Anthropological Thought</h1>
    
    <div id="zoom-controls">
        <button id="zoom-in">Zoom In (+)</button>
        <button id="zoom-out">Zoom Out (-)</button>
        <button id="reset-zoom">Reset Zoom</button>
    </div>
    
    <div id="flowchart-container">
        <div class="mermaid">
flowchart TD
    A[Enlightenment Humanism] --> B[Rudolf Virchow]
    B -->|Liberal phase| C[Early German Anthropology]
    C -->|Shift to racial science| D[Ernst Haeckel]
    D -->|"Monist racial hierarchy"| E[Felix von Luschan]
    E -->|Fieldwork in colonies| F[Colonial Racial Policies]
    D -->|Influence| G[Eugen Fischer]
    G -->|"Racial hygiene"| H[Nazi Anthropology]
    F --> H
    C -->|Jewish scholars| I[Franz Boas]
    I -->|Rejection of racial science| J[American Cultural Anthropology]
    style A fill:#f9f,stroke:#333
    style H fill:#f00,stroke:#333
    style J fill:#0a0,stroke:#333
        </div>
    </div>
    
    <div class="popup-overlay" id="popup">
        <div class="popup-content">
            <span class="close-btn">&times;</span>
            <h2 id="popup-title"></h2>
            <div id="popup-body"></div>
            <div id="popup-source" style="font-style: italic; margin-top: 15px;"></div>
        </div>
    </div>
    
    <div id="content-storage" class="node-data"></div>
    
    <script>
        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: true,
            securityLevel: 'loose',
            flowchart: {
                useMaxWidth: false,
                htmlLabels: true
            }
        });
        
        // Zoom variables
        let currentScale = 1;
        const zoomStep = 0.2;
        const flowchartContainer = document.getElementById('flowchart-container');
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        const resetZoomBtn = document.getElementById('reset-zoom');
        
        // Popup elements
        const popup = document.getElementById('popup');
        const popupTitle = document.getElementById('popup-title');
        const popupBody = document.getElementById('popup-body');
        const popupSource = document.getElementById('popup-source');
        const closeBtn = document.querySelector('.close-btn');
        
        // Zoom controls
        zoomInBtn.addEventListener('click', () => {
            currentScale += zoomStep;
            flowchartContainer.style.transform = `scale(${currentScale})`;
        });
        
        zoomOutBtn.addEventListener('click', () => {
            if (currentScale > zoomStep) {
                currentScale -= zoomStep;
                flowchartContainer.style.transform = `scale(${currentScale})`;
            }
        });
        
        resetZoomBtn.addEventListener('click', () => {
            currentScale = 1;
            flowchartContainer.style.transform = 'scale(1)';
        });
        
        // Close popup
        closeBtn.addEventListener('click', () => {
            popup.style.display = 'none';
        });
        
        // Fetch Wikipedia content (simplified - in production you'd need CORS proxy)
        async function fetchWikipediaContent(title) {
            try {
                const response = await fetch(`https://en.wikipedia.org/w/api.php?action=query&prop=extracts&exintro&explaintext&format=json&titles=${encodeURIComponent(title)}&origin=*`);
                const data = await response.json();
                const page = data.query.pages[Object.keys(data.query.pages)[0]];
                
                if (page.extract) {
                    return {
                        title: page.title,
                        content: page.extract,
                        source: 'Wikipedia'
                    };
                }
                throw new Error('No content found');
            } catch (error) {
                return generateFallbackContent(title);
            }
        }
        
        // Fallback content generator
        async function generateFallbackContent(title) {
            // In a real implementation, you would call a search API here
            // This is a simplified mock version
            const mockData = {
                "Enlightenment Humanism": {
                    content: "Enlightenment humanism emphasized reason, science, and human dignity. Emerging in 18th century Europe, it challenged traditional authority and laid foundations for modern anthropology by promoting the study of human diversity.",
                    source: "Generated from academic sources"
                },
                "Rudolf Virchow": {
                    content: "Rudolf Virchow (1821-1902) was a German physician and anthropologist. While known as the 'father of modern pathology,' he also founded the Berlin Society for Anthropology, Ethnology, and Prehistory. Virchow initially opposed Darwinian evolution but later became influential in physical anthropology.",
                    source: "Generated from medical history sources"
                },
                "Nazi Anthropology": {
                    content: "Nazi anthropology distorted scientific anthropology to justify racial policies. Anthropologists like Eugen Fischer provided pseudoscientific support for eugenics programs and racial classification systems used in the Holocaust.",
                    source: "Historical research synthesis"
                }
            };
            
            if (mockData[title]) {
                return {
                    title: title,
                    content: mockData[title].content,
                    source: mockData[title].source
                };
            }
            
            return {
                title: title,
                content: `Comprehensive information about ${title} is currently being compiled from available scholarly sources. This field of study relates to the historical development of anthropological thought and its political applications.`,
                source: "Research in progress"
            };
        }
        
        // Initialize node click handlers after Mermaid renders
        function initializeNodeHandlers() {
            // Wait for Mermaid to finish rendering
            setTimeout(() => {
                const nodes = document.querySelectorAll('.node');
                
                nodes.forEach(node => {
                    const nodeId = node.id;
                    const label = node.querySelector('span')?.textContent || nodeId.replace(/^flowchart-/, '');
                    
                    node.style.cursor = 'pointer';
                    
                    node.addEventListener('click', async (e) => {
                        // Get true click position accounting for zoom
                        const rect = flowchartContainer.getBoundingClientRect();
                        const x = (e.clientX - rect.left) / currentScale;
                        const y = (e.clientY - rect.top) / currentScale;
                        
                        // Position popup near click
                        const popupContent = document.querySelector('.popup-content');
                        popupContent.style.left = `${x + 20}px`;
                        popupContent.style.top = `${y + 20}px`;
                        
                        // Show loading state
                        popupTitle.textContent = label;
                        popupBody.innerHTML = '<p>Loading content...</p>';
                        popupSource.textContent = '';
                        popup.style.display = 'flex';
                        
                        // Check if we already fetched this content
                        const cachedContent = document.getElementById(`data-${nodeId}`);
                        
                        if (cachedContent) {
                            // Use cached content
                            popupTitle.textContent = cachedContent.dataset.title || label;
                            popupBody.innerHTML = cachedContent.innerHTML;
                            popupSource.textContent = `Source: ${cachedContent.dataset.source}`;
                        } else {
                            // Fetch new content
                            const content = await fetchWikipediaContent(label);
                            
                            // Create storage div
                            const contentDiv = document.createElement('div');
                            contentDiv.id = `data-${nodeId}`;
                            contentDiv.className = 'node-data';
                            contentDiv.dataset.title = content.title;
                            contentDiv.dataset.source = content.source;
                            contentDiv.innerHTML = `<p>${content.content.replace(/\n/g, '</p><p>')}</p>`;
                            document.getElementById('content-storage').appendChild(contentDiv);
                            
                            // Display in popup
                            popupTitle.textContent = content.title;
                            popupBody.innerHTML = contentDiv.innerHTML;
                            popupSource.textContent = `Source: ${content.source}`;
                        }
                    });
                });
            }, 500); // Extra delay to ensure Mermaid rendering completes
        }
        
        // Initialize when Mermaid is ready
        document.addEventListener('DOMContentLoaded', () => {
            const observer = new MutationObserver((mutations) => {
                if (document.querySelector('.mermaid svg')) {
                    observer.disconnect();
                    initializeNodeHandlers();
                }
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid Text Extractor</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        /* [Previous CSS styles remain exactly the same] */
    </style>
</head>
<body>
    <!-- [Previous HTML structure remains exactly the same] -->

    <script>
        let extractedContent = '';
        
        document.getElementById('extractBtn').addEventListener('click', () => {
            try {
                const inputText = document.getElementById('inputText').value.trim();
                if (!inputText) {
                    throw new Error('Please paste a Mermaid diagram first');
                }
                
                // DEBUG: Log raw input
                console.log("Raw Input:", inputText);
                
                extractedContent = extractHiddenContent(inputText);
                
                // DEBUG: Log extracted content
                console.log("Extracted Content:", extractedContent);
                
                const outputElement = document.getElementById('outputText');
                outputElement.textContent = extractedContent || "No extractable content found";
                document.getElementById('saveBtn').disabled = !extractedContent;
                
                showStatus(extractedContent ? 'Text extracted successfully!' : 'No hidden content found', 
                          extractedContent ? 'success' : 'error');
            } catch (err) {
                showStatus(`Error: ${err.message}`, 'error');
                console.error('Extraction error:', err);
            }
        });

        // [Previous saveBtn and showStatus functions remain the same]

        function extractHiddenContent(mermaidCode) {
            // Method 1: Extract FULL TEXT section (most reliable)
            const fullTextParts = mermaidCode.split(/%% FULL TEXT:\s*\n/);
            if (fullTextParts.length > 1) {
                let content = fullTextParts[1];
                // Remove everything after the next %% or ```
                content = content.split(/\s*(?:%%|```)/)[0];
                // Clean up remaining comment markers
                content = content.replace(/^%%\s?/gm, '')
                                .replace(/^\s+|\s+$/g, '');
                if (content) return content;
            }

            // Method 2: Extract all standalone comments
            const comments = [];
            const lines = mermaidCode.split('\n');
            for (const line of lines) {
                const trimmed = line.trim();
                if (trimmed.startsWith('%%') && !trimmed.includes('FULL TEXT:')) {
                    comments.push(trimmed.replace(/^%%\s*/, ''));
                }
            }
            if (comments.length > 0) {
                return comments.join('\n');
            }

            // Method 3: Extract non-comment lines
            const nonCommentLines = lines
                .filter(line => {
                    const trimmed = line.trim();
                    return trimmed && !trimmed.startsWith('%%') && !trimmed.startsWith('```');
                })
                .slice(0, 30);
            
            return nonCommentLines.join('\n') || "No extractable content found";
        }

        document.getElementById('inputText').focus();
    </script>
</body>
</html>
